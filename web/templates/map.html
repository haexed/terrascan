{% extends "base.html" %}

{% block title %}ğŸŒ Terrascan - Live Planetary Monitoring{% endblock %}

{% block leaflet_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
{% endblock %}



{% block content %}
<!-- Aggregate Stats Banner -->
<div class="stats-banner">
    <div class="stats-banner-content">
        <div class="stat-item">
            <span class="stat-icon">ğŸ”¥</span>
            <span class="stat-value" id="banner-fires">{{ health_data.fires.count if health_data.fires.count else 'â€”' }}</span>
            <span class="stat-label">Active Fires</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">ğŸŒ¬ï¸</span>
            <span class="stat-value" id="banner-air">{{ health_data.air_quality.avg_pm25 if health_data.air_quality.avg_pm25 else 'â€”' }}{{ ' Î¼g/mÂ³' if health_data.air_quality.avg_pm25 else '' }}</span>
            <span class="stat-label">Global AQI</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">ğŸŒŠ</span>
            <span class="stat-value" id="banner-ocean">{{ health_data.ocean_temperature.avg_temp if health_data.ocean_temperature.avg_temp else 'â€”' }}{{ 'Â°C' if health_data.ocean_temperature.avg_temp else '' }}</span>
            <span class="stat-label">Ocean Temp</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">ğŸŒ</span>
            <span class="stat-value" id="banner-health">{{ health_score.score if health_score.score else 'â€”' }}/100</span>
            <span class="stat-label">Health Score</span>
        </div>
        <div class="stat-item scan-status" id="scan-status-banner" style="display: none;">
            <span class="stat-icon">ğŸ”</span>
            <span class="stat-value">Scanning...</span>
        </div>
    </div>
</div>

<!-- Main Map Container -->
<div id="map"></div>

<!-- Control Panel -->
<div class="control-panel" id="control-panel">
    <div class="control-header" onclick="toggleControlPanel()">
        <h5 class="mb-0"><strong>ğŸŒ Terrascan</strong></h5>
        <span class="collapse-icon" id="collapse-icon">â–¼</span>
    </div>
    <div class="control-body" id="control-body">
        <p class="small mb-2 text-muted">Live Environmental Layers</p>

        <!-- Fire Layer Toggle -->
        <label class="layer-toggle">
            <span class="layer-icon">ğŸ”¥</span>
            <div class="layer-info">
                <strong>Active Fires</strong>
                <span class="layer-source">NASA FIRMS</span>
            </div>
            <input type="checkbox" id="fire-layer" checked>
            <span class="toggle-switch"></span>
        </label>

        <!-- Air Quality Layer Toggle -->
        <label class="layer-toggle">
            <span class="layer-icon">ğŸŒ¬ï¸</span>
            <div class="layer-info">
                <strong>Air Quality</strong>
                <span class="layer-source">OpenAQ PM2.5</span>
            </div>
            <input type="checkbox" id="air-layer" checked>
            <span class="toggle-switch"></span>
        </label>

        <!-- Ocean Layer Toggle -->
        <label class="layer-toggle">
            <span class="layer-icon">ğŸŒŠ</span>
            <div class="layer-info">
                <strong>Ocean Temp</strong>
                <span class="layer-source">Open-Meteo SST</span>
            </div>
            <input type="checkbox" id="ocean-layer" checked>
            <span class="toggle-switch"></span>
        </label>

        <!-- Conflict Layer Toggle -->
        <label class="layer-toggle">
            <span class="layer-icon">âš”ï¸</span>
            <div class="layer-info">
                <strong>Conflicts</strong>
                <span class="layer-source">UCDP Events</span>
            </div>
            <input type="checkbox" id="conflict-layer" checked>
            <span class="toggle-switch"></span>
        </label>

        <!-- Biodiversity Layer Toggle -->
        <label class="layer-toggle">
            <span class="layer-icon">ğŸ¦‹</span>
            <div class="layer-info">
                <strong>Biodiversity</strong>
                <span class="layer-source">GBIF Hotspots</span>
            </div>
            <input type="checkbox" id="biodiversity-layer" checked>
            <span class="toggle-switch"></span>
        </label>

        <!-- Aurora Layer Toggle -->
        <label class="layer-toggle">
            <span class="layer-icon">ğŸŒŒ</span>
            <div class="layer-info">
                <strong>Aurora</strong>
                <span class="layer-source" id="kp-status">NOAA SWPC</span>
            </div>
            <input type="checkbox" id="aurora-layer" checked>
            <span class="toggle-switch"></span>
        </label>

        <hr class="my-2">

        <!-- Map Style Toggle -->
        <label class="layer-toggle">
            <span class="layer-icon">ğŸ›°ï¸</span>
            <div class="layer-info">
                <strong>Satellite View</strong>
                <span class="layer-source">High Resolution</span>
            </div>
            <input type="checkbox" id="satellite-view" checked>
            <span class="toggle-switch"></span>
        </label>
    </div>
</div>

<!-- Health Score Widget (clickable for breakdown) -->
<div class="health-score-widget" onclick="toggleHealthBreakdown()" style="cursor: pointer;" title="Click for breakdown">
    <h6 class="mb-2">ğŸŒ Planetary Health</h6>
    <div class="health-score status-{{ health_score.status.lower() if health_score else 'unknown' }}">
        {{ health_score.score if health_score else '--' }}/100
    </div>
    <div class="mt-1 small status-{{ health_score.status.lower() if health_score else 'unknown' }}">
        {{ health_score.status if health_score else 'No Data' }}
    </div>
    <div class="small mt-1 text-muted">
        {{ health_score.sources_used if health_score else 0 }}/{{ health_score.sources_total if health_score else 3 }} sources
    </div>
</div>

<!-- Health Score Breakdown Panel -->
<div class="health-breakdown-panel" id="health-breakdown" style="display: none;">
    <div class="breakdown-header">
        <strong>Score Breakdown</strong>
        <span class="close-breakdown" onclick="toggleHealthBreakdown()">&times;</span>
    </div>
    <div class="breakdown-content">
        {% if health_score and health_score.breakdown %}
        {% for item in health_score.breakdown %}
        <div class="breakdown-item">
            <span class="breakdown-icon">{{ item.icon }}</span>
            <span class="breakdown-label">{{ item.source }}</span>
            <span class="breakdown-value">{{ item.value }}</span>
            <span class="breakdown-impact {% if item.impact < 0 %}negative{% else %}neutral{% endif %}">
                {{ item.impact if item.impact != 0 else 'Â±0' }}
            </span>
            {% if freshness[item.provider] %}
            <span class="freshness-dot" style="background: {{ freshness[item.provider].color }};" title="{{ freshness[item.provider].status }}"></span>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div class="text-muted small">No breakdown available</div>
        {% endif %}
    </div>
</div>

<!-- Scan Area Button (appears when zoomed in) -->
<button class="scan-btn" id="scan-btn" onclick="scanCurrentArea()" title="Scan this area for more data" style="display: none;">
    <i class="fas fa-search-location text-white fs-4" id="scan-icon"></i>
    <span class="scan-label">Scan Area</span>
</button>

<!-- Refresh Button -->
<button class="refresh-btn" onclick="refreshMapData()" title="Refresh Environmental Data">
    <i class="fas fa-sync-alt text-white fs-4" id="refresh-icon"></i>
</button>
{% endblock %}

{% block footer_container %}{% endblock %}

{% block leaflet_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
{% endblock %}
